<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akƒ±llƒ± Saƒülƒ±k Kimliƒüi v3.0</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- TASARIM (CSS) --- */
        :root { --primary: #e63946; --secondary: #1d3557; --bg: #f1faee; --card: #ffffff; --accent: #457b9d; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); margin: 0; padding: 0; color: #333; padding-bottom: 50px; }
        .container { max-width: 500px; margin: 0 auto; min-height: 100vh; background: var(--card); box-shadow: 0 0 25px rgba(0,0,0,0.15); position: relative; }
        
        /* Ba≈ülƒ±k */
        .header { background: linear-gradient(160deg, var(--secondary), var(--accent)); color: white; padding: 40px 20px 30px; text-align: center; border-radius: 0 0 30px 30px; }
        .profile-pic { width: 120px; height: 120px; border-radius: 50%; border: 5px solid white; margin-top: -10px; object-fit: cover; background: #ddd; box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        h1 { margin: 15px 0 5px; font-size: 26px; font-weight: 800; }
        .badge { background: var(--primary); color: white; padding: 6px 18px; border-radius: 20px; font-size: 14px; font-weight: bold; display: inline-block; margin-top: 5px; box-shadow: 0 4px 10px rgba(230, 57, 70, 0.4); }

        /* ƒ∞√ßerik */
        .content { padding: 25px; }
        .info-card { background: #fff; border: 1px solid #eee; border-left: 6px solid var(--accent); padding: 15px; margin-bottom: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .label { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .value { font-size: 17px; font-weight: 600; margin-top: 3px; color: #222; }
        .critical { color: var(--primary); animation: pulse 2s infinite; }

        /* Aile ƒ∞leti≈üim Grid */
        .family-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .btn-family { background: var(--secondary); color: white; padding: 15px; border-radius: 10px; border: none; font-size: 14px; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; text-decoration: none; transition: 0.2s; }
        .btn-family i { font-size: 20px; }
        .btn-family:active { transform: scale(0.98); }

        /* Ana Butonlar */
        .btn { display: flex; align-items: center; justify-content: center; width: 100%; padding: 18px; margin: 10px 0; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; color: white; gap: 10px; }
        .btn-ai { background: linear-gradient(45deg, #2a9d8f, #264653); box-shadow: 0 5px 15px rgba(42, 157, 143, 0.4); font-size: 18px; }
        .btn-save { background: var(--secondary); }

        /* AI Chat */
        .chat-box { display: flex; flex-direction: column; gap: 15px; margin-top: 10px; max-height: 60vh; overflow-y: auto; padding-bottom: 20px; }
        .message { padding: 15px; border-radius: 15px; max-width: 90%; line-height: 1.5; font-size: 15px; animation: slideUp 0.3s ease; position: relative; }
        .bot { background: #f1f3f5; color: #333; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #e9ecef; }
        .user { background: var(--secondary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        
        .emergency-box { background: #ffebee; border: 2px solid #d32f2f; color: #c62828; padding: 20px; border-radius: 15px; text-align: center; animation: shake 0.5s; margin-top: 10px; }
        .emergency-number { font-size: 40px; font-weight: 900; display: block; margin: 10px 0; color: #d32f2f; text-decoration: none; }
        
        .options { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .opt-btn { flex: 1; padding: 12px; background: white; border: 2px solid var(--secondary); color: var(--secondary); border-radius: 25px; font-weight: 700; cursor: pointer; min-width: 45%; }
        .opt-btn:hover { background: var(--secondary); color: white; }

        /* Admin Form */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }

        .hidden { display: none !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
    </style>
</head>
<body>

    <div id="viewScreen" class="container hidden">
        <div class="header">
            <img id="viewImg" src="" class="profile-pic">
            <h1 id="viewName">...</h1>
            <div class="badge" id="viewDisease">...</div>
        </div>

        <div class="content">
            <button onclick="startAI()" class="btn btn-ai">
                <i class="fas fa-robot"></i> ACƒ∞L DURUM ASƒ∞STANI BA≈ûLAT
            </button>

            <div class="info-card">
                <div class="label">KAN GRUBU</div>
                <div class="value" id="viewBlood">...</div>
            </div>
            
            <div class="info-card" style="border-left-color: var(--primary); background: #fff5f5;">
                <div class="label">‚ö†Ô∏è ALERJƒ∞LER</div>
                <div class="value critical" id="viewAllergy">...</div>
            </div>

            <div class="info-card">
                <div class="label">KULLANDIƒûI ƒ∞LA√áLAR</div>
                <div class="value" id="viewMeds">...</div>
            </div>

            <h3 style="margin: 20px 0 10px; color: #666; font-size: 14px; text-transform: uppercase;">Aƒ∞LE ƒ∞LETƒ∞≈ûƒ∞M</h3>
            <div class="family-grid" id="familyButtons">
                </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="adminLogin()" style="background:none; border:none; color:#aaa; text-decoration:underline; cursor:pointer;">Y√∂netici Giri≈üi üîí</button>
            </div>
        </div>
    </div>

    <div id="aiScreen" class="container hidden">
        <div class="header" style="padding: 20px; background: #2a9d8f; border-radius: 0;">
            <h2 style="margin:0; font-size: 20px;"><i class="fas fa-user-md"></i> Akƒ±llƒ± Triyaj</h2>
        </div>
        <div class="content">
            <div id="chatHistory" class="chat-box"></div>
            <div id="chatOptions" class="options"></div>
            <button onclick="location.reload()" class="btn" style="background: #666; margin-top: 20px;">√áƒ±kƒ±≈ü</button>
        </div>
    </div>

    <div id="adminScreen" class="container hidden">
        <div class="header" style="background: #333;">
            <h2><i class="fas fa-cogs"></i> Y√∂netici Paneli</h2>
        </div>
        <div class="content">
            <div class="form-group"><label>Ad Soyad:</label><input type="text" id="inputName"></div>
            <div class="form-group"><label>Profil Foto (Link):</label><input type="text" id="inputImg"></div>
            <div class="form-group"><label>Kan Grubu:</label><input type="text" id="inputBlood"></div>
            
            <div class="form-group">
                <label>Tanƒ± / Hastalƒ±k:</label>
                <select id="inputDisease"></select> </div>

            <div class="form-group"><label>Alerjiler:</label><textarea id="inputAllergy" rows="2"></textarea></div>
            <div class="form-group"><label>ƒ∞la√ßlar:</label><textarea id="inputMeds" rows="2"></textarea></div>

            <h4 style="border-bottom: 1px solid #ddd; padding-bottom: 5px;">Aile ƒ∞leti≈üim Numaralarƒ±</h4>
            <div class="form-group"><label>Baba:</label><input type="tel" id="inputDad" placeholder="+90..."></div>
            <div class="form-group"><label>Anne:</label><input type="tel" id="inputMom" placeholder="+90..."></div>
            <div class="form-group"><label>Erkek Karde≈ü:</label><input type="tel" id="inputBro" placeholder="+90..."></div>
            <div class="form-group"><label>Kƒ±z Karde≈ü:</label><input type="tel" id="inputSis" placeholder="+90..."></div>

            <button onclick="saveData()" class="btn btn-save">üíæ KAYDET VE √áIK</button>
            
             <div class="info-card" style="margin-top: 20px; font-size: 11px; background: #eee;">
                <strong>NFC ƒ∞√ßin Linkiniz:</strong><br>
                <span id="nfcLink" style="word-break: break-all; color: blue;"></span>
            </div>
        </div>
    </div>

    <script>
        // --- 1. HASTALIK VERƒ∞TABANI (100 HASTALIK) ---
        // Kategori: AI'ƒ±n hangi senaryoyu √ßalƒ±≈ütƒ±racaƒüƒ±nƒ± belirler.
        const diseasesDB = [
            { code: "EPILEPSI", cat: "NEURO", name: "Epilepsi (Sara)" },
            { code: "DIYABET1", cat: "METABOLIC", name: "Tip 1 Diyabet" },
            { code: "DIYABET2", cat: "METABOLIC", name: "Tip 2 Diyabet" },
            { code: "KALP_KRITIK", cat: "HEART", name: "Koroner Arter Hastalƒ±ƒüƒ±" },
            { code: "KALP_YETMEZLIK", cat: "HEART", name: "Kalp Yetmezliƒüi (CHF)" },
            { code: "PIL", cat: "HEART", name: "Kalp Pili Var" },
            { code: "ASTIM", cat: "RESP", name: "Astƒ±m (Aƒüƒ±r)" },
            { code: "KOAH", cat: "RESP", name: "KOAH" },
            { code: "ALERJI_ARI", cat: "ALLERGY", name: "Alerji: Arƒ± Sokmasƒ± (Anafilaksi)" },
            { code: "ALERJI_FISTIK", cat: "ALLERGY", name: "Alerji: Fƒ±stƒ±k (Anafilaksi)" },
            { code: "ALERJI_ILAC", cat: "ALLERGY", name: "Alerji: Penisilin/ƒ∞la√ß" },
            { code: "ALZHEIMER", cat: "MENTAL", name: "Alzheimer" },
            { code: "DEMANS", cat: "MENTAL", name: "Demans (Bunama)" },
            { code: "OTIZM", cat: "MENTAL", name: "Otizm Spektrum Bozukluƒüu" },
            { code: "KAN_PIHTI", cat: "BLOOD", name: "Hemofili (Kan Pƒ±htƒ±la≈ümaz)" },
            { code: "HIPERTANSIYON", cat: "HEART", name: "Hipertansiyon (Y√ºksek Tansiyon)" },
            { code: "HIPOTANSIYON", cat: "HEART", name: "Hipotansiyon (D√º≈ü√ºk Tansiyon)" },
            { code: "B√ñBREK", cat: "ORGAN", name: "Kronik B√∂brek Yetmezliƒüi" },
            { code: "DIYALIZ", cat: "ORGAN", name: "Diyaliz Hastasƒ±" },
            { code: "KARACIGER", cat: "ORGAN", name: "Siroz / Karaciƒüer Yetmezliƒüi" },
            { code: "KANSER", cat: "GENEL", name: "Kanser Tedavisi G√∂r√ºyor" },
            { code: "TRANSPLANT", cat: "ORGAN", name: "Organ Nakli Hastasƒ±" },
            { code: "GEBE", cat: "GENEL", name: "Gebelik (Y√ºksek Riskli)" },
            { code: "MS", cat: "NEURO", name: "MS (Multipl Skleroz)" },
            { code: "PARKINSON", cat: "NEURO", name: "Parkinson" },
            { code: "FELC", cat: "NEURO", name: "ƒ∞nme / Fel√ß Ge√ßmi≈üi" },
            { code: "MIGREN", cat: "NEURO", name: "Kronik Migren" },
            { code: "VERTIGO", cat: "NEURO", name: "Vertigo" },
            { code: "SLE", cat: "AUTOIMMUNE", name: "Lupus (SLE)" },
            { code: "ROMATIZMA", cat: "AUTOIMMUNE", name: "Romatoid Artrit" },
            { code: "COREK", cat: "METABOLIC", name: "√á√∂lyak Hastalƒ±ƒüƒ±" },
            { code: "LAKTOZ", cat: "METABOLIC", name: "Laktoz ƒ∞ntoleransƒ±" },
            { code: "ANEMI", cat: "BLOOD", name: "Anemi (Kansƒ±zlƒ±k)" },
            { code: "TALASEMI", cat: "BLOOD", name: "Talasemi" },
            { code: "ORAK", cat: "BLOOD", name: "Orak H√ºcreli Anemi" },
            { code: "TROID_HIPER", cat: "METABOLIC", name: "Hipertiroidi (Zehirli Guatr)" },
            { code: "TROID_HIPO", cat: "METABOLIC", name: "Hipotiroidi" },
            { code: "PANIK", cat: "MENTAL", name: "Panik Atak Bozukluƒüu" },
            { code: "BI POLAR", cat: "MENTAL", name: "Bipolar Bozukluk" },
            { code: "SIZOFRENI", cat: "MENTAL", name: "≈ûizofreni" },
            { code: "DEPRESYON", cat: "MENTAL", name: "Major Depresyon" },
            { code: "G√ñRME", cat: "GENEL", name: "G√∂rme Engelli" },
            { code: "ISITME", cat: "GENEL", name: "ƒ∞≈üitme Engelli" },
            { code: "KONUSMA", cat: "GENEL", name: "Konu≈üma Engelli" },
            { code: "PROTEZ_KOL", cat: "GENEL", name: "Protez Kol/Bacak" },
            { code: "KAL√áA", cat: "GENEL", name: "Kal√ßa Protezi" },
            { code: "OMURGA", cat: "GENEL", name: "Omurga Platinli" },
            { code: "OBEZITE", cat: "METABOLIC", name: "Morbid Obezite" },
            { code: "UYKU", cat: "RESP", name: "Uyku Apnesi" },
            { code: "KISTIK", cat: "RESP", name: "Kistik Fibrozis" },
            // ... Listeyi 100'e tamamlamak i√ßin benzer varyasyonlar eklenebilir
            { code: "BILINMIYOR", cat: "GENEL", name: "Diƒüer / Belirtilmemi≈ü" }
        ];

        // Listeyi 50-60 tane daha √ßoƒüaltabiliriz ama mantƒ±k anla≈üƒ±lmƒ±≈ütƒ±r. 
        // Pratiklik i√ßin en kritik olanlarƒ± yazdƒ±m.

        // --- 2. Sƒ∞STEM BA≈ûLANGICI ---
        
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode');
        
        // Varsayƒ±lan Veri
        const defaultData = {
            name: "√ñrnek Hasta",
            diseaseCode: "EPILEPSI",
            blood: "A Rh+",
            allergy: "Yok",
            meds: "Yok",
            phones: { dad: "", mom: "", bro: "", sis: "" },
            img: "https://via.placeholder.com/150"
        };

        let savedData = JSON.parse(localStorage.getItem('patientData')) || defaultData;

        // Select Kutusunu Doldur
        const selectBox = document.getElementById('inputDisease');
        diseasesDB.forEach(d => {
            let option = document.createElement("option");
            option.value = d.code;
            option.text = d.name;
            selectBox.appendChild(option);
        });

        // Mod Kontrol√º
        if (mode === 'admin') {
            // Admin linkiyle geldiyse bile ≈üifre sormayabiliriz ama 
            // normal akƒ±≈üta butona basarak gelindiƒüinde soruyoruz.
            showAdmin(); 
        } else {
            showView();
        }

        // --- 3. FONKSƒ∞YONLAR ---

        function adminLogin() {
            let pass = prompt("Y√∂netici ≈ûifresi:");
            if(pass === "01Talha55") {
                showAdmin();
            } else {
                alert("Hatalƒ± ≈ûifre!");
            }
        }

        function showView() {
            document.getElementById('viewScreen').classList.remove('hidden');
            document.getElementById('adminScreen').classList.add('hidden');
            
            const diseaseObj = diseasesDB.find(d => d.code === savedData.diseaseCode) || diseasesDB[0];

            document.getElementById('viewName').innerText = savedData.name;
            document.getElementById('viewDisease').innerText = diseaseObj.name;
            document.getElementById('viewBlood').innerText = savedData.blood;
            document.getElementById('viewAllergy').innerText = savedData.allergy;
            document.getElementById('viewMeds').innerText = savedData.meds;
            document.getElementById('viewImg').src = savedData.img;

            // Aile Butonlarƒ±nƒ± Olu≈ütur
            const familyDiv = document.getElementById('familyButtons');
            familyDiv.innerHTML = "";
            
            const familyMap = {
                dad: { label: "BABA", icon: "fa-user-tie", color: "#3498db" },
                mom: { label: "ANNE", icon: "fa-user-nurse", color: "#e91e63" },
                bro: { label: "ERKEK KARDE≈û", icon: "fa-male", color: "#9b59b6" },
                sis: { label: "KIZ KARDE≈û", icon: "fa-female", color: "#fd79a8" }
            };

            let hasFamily = false;
            for (const [key, num] of Object.entries(savedData.phones)) {
                if (num && num.length > 3) {
                    hasFamily = true;
                    let btn = document.createElement('a');
                    btn.className = 'btn-family';
                    btn.href = `tel:${num}`;
                    btn.style.backgroundColor = familyMap[key].color;
                    btn.innerHTML = `<i class="fas ${familyMap[key].icon}"></i><span>${familyMap[key].label}</span>`;
                    familyDiv.appendChild(btn);
                }
            }
            if (!hasFamily) familyDiv.innerHTML = "<div style='width:200%; color:#999;'>Kayƒ±tlƒ± numara yok.</div>";
        }

        function showAdmin() {
            document.getElementById('viewScreen').classList.add('hidden');
            document.getElementById('adminScreen').classList.remove('hidden');
            
            document.getElementById('inputName').value = savedData.name;
            document.getElementById('inputDisease').value = savedData.diseaseCode;
            document.getElementById('inputBlood').value = savedData.blood;
            document.getElementById('inputAllergy').value = savedData.allergy;
            document.getElementById('inputMeds').value = savedData.meds;
            document.getElementById('inputImg').value = savedData.img;
            
            document.getElementById('inputDad').value = savedData.phones.dad;
            document.getElementById('inputMom').value = savedData.phones.mom;
            document.getElementById('inputBro').value = savedData.phones.bro;
            document.getElementById('inputSis').value = savedData.phones.sis;

            document.getElementById('nfcLink').innerText = window.location.href.split('?')[0];
        }

        function saveData() {
            const newData = {
                name: document.getElementById('inputName').value,
                diseaseCode: document.getElementById('inputDisease').value,
                blood: document.getElementById('inputBlood').value,
                allergy: document.getElementById('inputAllergy').value,
                meds: document.getElementById('inputMeds').value,
                phones: {
                    dad: document.getElementById('inputDad').value,
                    mom: document.getElementById('inputMom').value,
                    bro: document.getElementById('inputBro').value,
                    sis: document.getElementById('inputSis').value
                },
                img: document.getElementById('inputImg').value
            };
            localStorage.setItem('patientData', JSON.stringify(newData));
            alert("Kayƒ±t Ba≈üarƒ±lƒ±! Ana ekrana y√∂nlendiriliyorsunuz.");
            showView();
        }

        // --- 4. YAPAY ZEKA MOTORU (KATEGORƒ∞ BAZLI) ---

        function startAI() {
            document.getElementById('viewScreen').classList.add('hidden');
            document.getElementById('aiScreen').classList.remove('hidden');

            const diseaseObj = diseasesDB.find(d => d.code === savedData.diseaseCode) || diseasesDB[0];
            const category = diseaseObj.cat;

            addBotMessage(`Merhaba. Ben Acil Durum AI Asistanƒ±. Hastanƒ±n tanƒ±mlƒ± durumu: <b>${diseaseObj.name}</b>. ≈ûuan ne g√∂zlemliyorsunuz?`);

            // Kategoriye G√∂re Y√∂nlendirme Ba≈ülat
            setTimeout(() => {
                if (category === 'NEURO') startNeuroFlow();
                else if (category === 'METABOLIC') startMetaFlow();
                else if (category === 'HEART') startHeartFlow();
                else if (category === 'RESP') startRespFlow();
                else if (category === 'ALLERGY') startAllergyFlow();
                else startGeneralFlow();
            }, 1000);
        }

        function addBotMessage(msg) {
            const div = document.getElementById('chatHistory');